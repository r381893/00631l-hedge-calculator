<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ“¬åˆ†æä¸­å¿ƒ - 00631L é¿éšªè¨ˆç®—å™¨</title>
    <meta name="description" content="å¤šæƒ…å¢ƒæç›Šæ¨¡æ“¬åˆ†æå·¥å…· - ä¸‰ç­–ç•¥æ¯”è¼ƒ">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="css/style.css?v=1.1.47">
    <link rel="stylesheet" href="css/simulation.css?v=1.1.47">
    <style>
        .sim-page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--primary-color);
        }

        /* Tab Navigation */
        .sim-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
        }

        .sim-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .sim-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .sim-tab.active {
            color: var(--primary-color);
        }

        .sim-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        .sim-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .sim-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Strategy Summary Cards */
        .strategy-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .strategy-summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .strategy-summary-card {
            padding: 16px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-color);
        }

        .strategy-summary-card.strategy-a {
            border-left: 4px solid #ef4444;
        }

        .strategy-summary-card.strategy-b {
            border-left: 4px solid #3b82f6;
        }

        .strategy-summary-card.strategy-c {
            border-left: 4px solid #22c55e;
        }

        .strategy-summary-card h4 {
            margin: 0 0 10px 0;
            font-size: 1rem;
        }

        .strategy-summary-card .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .strategy-summary-card .stat-row span:first-child {
            color: var(--text-secondary);
        }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .control-group input,
        .control-group select {
            padding: 10px 12px;
            background: var(--input-bg, #1e293b);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary, #fff);
            font-size: 1rem;
        }

        /* ä¸‹æ‹‰é¸å–®é¸é …æ¨£å¼ */
        .control-group select option {
            background: #1e293b;
            color: #fff;
            padding: 10px;
        }

        .control-group select option:hover,
        .control-group select option:checked {
            background: #3b82f6;
            color: #fff;
        }

        /* Results Table with 3 Strategies */
        .results-table-container {
            max-height: 500px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .results-table th,
        .results-table td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .results-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .results-table th:first-child,
        .results-table td:first-child {
            text-align: left;
        }

        .results-table .col-a {
            background: rgba(239, 68, 68, 0.05);
        }

        .results-table .col-b {
            background: rgba(59, 130, 246, 0.05);
        }

        .results-table .col-c {
            background: rgba(34, 197, 94, 0.05);
        }

        /* Chart */
        .chart-container {
            margin-top: 24px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .chart-container h3 {
            margin: 0 0 16px 0;
            font-size: 1.1rem;
        }

        /* Monte Carlo Stats Summary */
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
        }

        .results-summary .summary-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .results-summary .summary-item .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .results-summary .summary-item .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .results-summary .summary-item .value.profit {
            color: #22c55e;
        }

        .results-summary .summary-item .value.loss {
            color: #ef4444;
        }

        /* Scenario Cards */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .scenario-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .scenario-card.selected {
            border-color: var(--primary-color);
            background: rgba(139, 92, 246, 0.1);
        }

        .scenario-card h4 {
            margin: 0 0 6px 0;
            font-size: 1rem;
        }

        .scenario-card p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Actions */
        .action-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <div class="sim-page-container">
        <!-- Header -->
        <div class="page-header">
            <h1>ğŸ§ª æ¨¡æ“¬åˆ†æä¸­å¿ƒ</h1>
            <a href="index.html" class="back-link">â† è¿”å›ä¸»é </a>
        </div>

        <!-- Strategy Summary Cards -->
        <div class="strategy-summary-grid">
            <div class="strategy-summary-card strategy-a">
                <h4>ğŸ”´ ç­–ç•¥ A</h4>
                <div class="stat-row"><span>é¸æ“‡æ¬Šéƒ¨ä½:</span><span id="info-a-count">0 å£</span></div>
                <div class="stat-row"><span>å·²å¯¦ç¾æç›Š:</span><span id="info-a-realized">0</span></div>
            </div>
            <div class="strategy-summary-card strategy-b">
                <h4>ğŸ”µ ç­–ç•¥ B</h4>
                <div class="stat-row"><span>é¸æ“‡æ¬Šéƒ¨ä½:</span><span id="info-b-count">0 å£</span></div>
                <div class="stat-row"><span>å·²å¯¦ç¾æç›Š:</span><span id="info-b-realized">0</span></div>
            </div>
            <div class="strategy-summary-card strategy-c">
                <h4>ğŸŸ¢ ç­–ç•¥ C</h4>
                <div class="stat-row"><span>é¸æ“‡æ¬Šéƒ¨ä½:</span><span id="info-c-count">0 å£</span></div>
                <div class="stat-row"><span>å·²å¯¦ç¾æç›Š:</span><span id="info-c-realized">0</span></div>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <span>ETF: <strong id="info-etf-lots">0</strong> å¼µ</span> |
            <span>ç•¶å‰æŒ‡æ•¸: <strong id="info-current-index">--</strong></span>
        </div>

        <!-- Tab Navigation -->
        <div class="sim-tabs">
            <button class="sim-tab active" data-panel="batch">ğŸ“Š æ‰¹æ¬¡æ¨¡æ“¬</button>
            <button class="sim-tab" data-panel="scenario">ğŸ­ æƒ…å¢ƒåŠ‡æœ¬</button>
        </div>

        <!-- Panel: Batch -->
        <div class="sim-panel active" id="panel-batch">
            <div class="card">
                <h3>ğŸ“Š æ‰¹æ¬¡æ¨¡æ“¬ - ä¸‰ç­–ç•¥æ¯”è¼ƒ</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">è¨­å®šæ¨¡æ“¬å¤©æ•¸èˆ‡æ¯æ—¥æ¼²è·Œå¹…ï¼Œä¸€æ¬¡ç”¢ç”Ÿæ•´æ®µæœŸé–“ä¸‰å€‹ç­–ç•¥çš„æç›Šæ¯”è¼ƒè¡¨ã€‚</p>

                <div class="controls-grid">
                    <div class="control-group">
                        <label>å¤©æ•¸è¨­å®šæ–¹å¼</label>
                        <select id="batch-days-mode">
                            <option value="fixed">å›ºå®šå¤©æ•¸</option>
                            <option value="settlement">ä¾çµç®—æ—¥è¨ˆç®—</option>
                        </select>
                    </div>
                    <div class="control-group" id="batch-days-group">
                        <label>æ¨¡æ“¬å¤©æ•¸</label>
                        <input type="number" id="batch-days" value="10" min="1" max="60">
                    </div>
                    <div class="control-group" id="settlement-date-group" style="display: none;">
                        <label>çµç®—æ—¥ (åˆ°æœŸæ—¥)</label>
                        <input type="date" id="settlement-date">
                        <small id="days-remaining" style="color: var(--text-secondary); margin-top: 4px;">è·çµç®—æ—¥: --
                            å¤©</small>
                    </div>
                    <div class="control-group">
                        <label>èµ·å§‹æŒ‡æ•¸</label>
                        <input type="number" id="batch-start-index" placeholder="è‡ªå‹•å¸¶å…¥ç•¶å‰æŒ‡æ•¸">
                    </div>
                    <div class="control-group" id="daily-change-group">
                        <label id="daily-change-label">æ¯æ—¥æ¼²è·Œ (é»)</label>
                        <input type="number" id="batch-daily-change" value="250" step="10">
                        <small id="daily-change-hint" style="color: var(--text-secondary); margin-top: 4px;"></small>
                    </div>
                    <div class="control-group">
                        <label>æ³¢å‹•æ¨¡å¼</label>
                        <select id="batch-volatility-mode">
                            <option value="fixed">ğŸ“‰ å›ºå®šæ¼²è·Œ</option>
                            <option value="random">ğŸ² éš¨æ©Ÿæ³¢å‹• (Â±ç¯„åœ)</option>
                            <option value="random-large">ğŸ° å¤§å¹…éš¨æ©Ÿ (Â±2å€)</option>
                            <option value="trend">ğŸ“ˆ è¶¨å‹¢éå¢</option>
                            <option value="trend-down">ğŸ“‰ è¶¨å‹¢éæ¸›</option>
                            <option value="v-shape">ğŸ“‰ğŸ“ˆ Vå‹åè½‰</option>
                            <option value="inverse-v">ğŸ“ˆğŸ“‰ å€’Vå‹</option>
                            <option value="sideways">â†”ï¸ å°å¹…éœ‡ç›ª</option>
                            <option value="monte-carlo">ğŸ¯ è’™åœ°å¡ç¾…æ¨¡æ“¬</option>
                        </select>
                    </div>
                    <div class="control-group" id="mc-runs-group" style="display: none;">
                        <label>æ¨¡æ“¬æ¬¡æ•¸ (è’™åœ°å¡ç¾…)</label>
                        <input type="number" id="mc-runs" value="100" min="10" max="1000" step="10">
                    </div>
                </div>

                <button class="btn btn-primary btn-full" id="btn-run-batch">ğŸš€ åŸ·è¡Œæ‰¹æ¬¡æ¨¡æ“¬</button>

                <!-- è’™åœ°å¡ç¾…çµ±è¨ˆçµæœ -->
                <div id="mc-stats" class="results-summary" style="display: none; margin-top: 20px;">
                    <h4 style="grid-column: 1/-1; margin: 0 0 12px 0;">ğŸ¯ è’™åœ°å¡ç¾…æ¨¡æ“¬çµ±è¨ˆ (å…± <span
                            id="mc-total-runs">100</span> æ¬¡)</h4>
                    <div class="summary-item">
                        <div class="label">ç­–ç•¥A å¹³å‡æç›Š</div>
                        <div class="value" id="mc-avg-a">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ç­–ç•¥B å¹³å‡æç›Š</div>
                        <div class="value" id="mc-avg-b">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ç­–ç•¥C å¹³å‡æç›Š</div>
                        <div class="value" id="mc-avg-c">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ç­–ç•¥A å‹ç‡</div>
                        <div class="value" id="mc-winrate-a">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ç­–ç•¥B å‹ç‡</div>
                        <div class="value" id="mc-winrate-b">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ç­–ç•¥C å‹ç‡</div>
                        <div class="value" id="mc-winrate-c">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ğŸ”´ ç­–ç•¥A æœ€å¤§è™§æ</div>
                        <div class="value loss" id="mc-maxloss-a">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ğŸ”µ ç­–ç•¥B æœ€å¤§è™§æ</div>
                        <div class="value loss" id="mc-maxloss-b">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ğŸŸ¢ ç­–ç•¥C æœ€å¤§è™§æ</div>
                        <div class="value loss" id="mc-maxloss-c">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ğŸ”´ ç­–ç•¥A æœ€å¤§ç²åˆ©</div>
                        <div class="value profit" id="mc-maxprofit-a">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ğŸ”µ ç­–ç•¥B æœ€å¤§ç²åˆ©</div>
                        <div class="value profit" id="mc-maxprofit-b">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ğŸŸ¢ ç­–ç•¥C æœ€å¤§ç²åˆ©</div>
                        <div class="value profit" id="mc-maxprofit-c">--</div>
                    </div>
                </div>


                <div class="results-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>å¤©æ•¸</th>
                                <th>æŒ‡æ•¸</th>
                                <th>ç´¯è¨ˆè®Šå‹•</th>
                                <th>ETF æç›Š</th>
                                <th class="col-a">ğŸ”´ ç­–ç•¥A</th>
                                <th class="col-b">ğŸ”µ ç­–ç•¥B</th>
                                <th class="col-c">ğŸŸ¢ ç­–ç•¥C</th>
                                <th class="col-a">ç¸½æç›ŠA</th>
                                <th class="col-b">ç¸½æç›ŠB</th>
                                <th class="col-c">ç¸½æç›ŠC</th>
                            </tr>
                        </thead>
                        <tbody id="batch-result-body">
                            <tr>
                                <td colspan="10" style="text-align: center; color: var(--text-secondary);">
                                    è«‹è¨­å®šåƒæ•¸å¾Œé»æ“Šã€ŒåŸ·è¡Œæ‰¹æ¬¡æ¨¡æ“¬ã€</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="chart-container">
                    <h3>ğŸ“ˆ ä¸‰ç­–ç•¥æç›Šæ›²ç·š</h3>
                    <canvas id="batch-chart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Panel C: Scenario -->
        <div class="sim-panel" id="panel-scenario">
            <div class="card">
                <h3>ğŸ­ æƒ…å¢ƒåŠ‡æœ¬ - ä¸‰ç­–ç•¥æ¯”è¼ƒ</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">é»æ“Šä»»ä¸€æƒ…å¢ƒå¡ç‰‡å³å¯åŸ·è¡Œæ¨¡æ“¬ï¼Œå¤©æ•¸æœƒè‡ªå‹•æ ¹æ“šæ‚¨çš„è¨­å®šèª¿æ•´ã€‚</p>

                <div class="controls-grid" style="margin-bottom: 20px;">
                    <div class="control-group">
                        <label>æ¨¡æ“¬å¤©æ•¸</label>
                        <input type="number" id="scenario-days" value="3" min="1" max="30">
                    </div>
                    <div class="control-group">
                        <label>èµ·å§‹æŒ‡æ•¸</label>
                        <input type="number" id="scenario-start-index" placeholder="è‡ªå‹•å¸¶å…¥ç•¶å‰æŒ‡æ•¸">
                    </div>
                </div>

                <div class="scenario-grid">
                    <div class="scenario-card" data-scenario="crash" onclick="runScenario('crash')">
                        <h4>ğŸ”» æ€¥è·Œ</h4>
                        <p>æ¯æ—¥ä¸‹è·Œ <strong>300</strong> é»</p>
                    </div>
                    <div class="scenario-card" data-scenario="rally" onclick="runScenario('rally')">
                        <h4>ğŸš€ æ€¥æ¼²</h4>
                        <p>æ¯æ—¥ä¸Šæ¼² <strong>300</strong> é»</p>
                    </div>
                    <div class="scenario-card" data-scenario="moderate-drop" onclick="runScenario('moderate-drop')">
                        <h4>ğŸ“‰ ç·©è·Œ</h4>
                        <p>æ¯æ—¥ä¸‹è·Œ <strong>100</strong> é»</p>
                    </div>
                    <div class="scenario-card" data-scenario="moderate-rise" onclick="runScenario('moderate-rise')">
                        <h4>ğŸ“ˆ ç·©æ¼²</h4>
                        <p>æ¯æ—¥ä¸Šæ¼² <strong>100</strong> é»</p>
                    </div>
                    <div class="scenario-card" data-scenario="v-shape" onclick="runScenario('v-shape')">
                        <h4>ğŸ“‰ğŸ“ˆ Vå‹</h4>
                        <p>å…ˆè·Œå¾Œæ¼²</p>
                    </div>
                    <div class="scenario-card" data-scenario="inverse-v" onclick="runScenario('inverse-v')">
                        <h4>ğŸ“ˆğŸ“‰ å€’V</h4>
                        <p>å…ˆæ¼²å¾Œè·Œ</p>
                    </div>
                    <div class="scenario-card" data-scenario="sideways" onclick="runScenario('sideways')">
                        <h4>â†”ï¸ ç›¤æ•´</h4>
                        <p>Â±150 é»éœ‡ç›ª</p>
                    </div>
                    <div class="scenario-card" data-scenario="black-swan" onclick="runScenario('black-swan')">
                        <h4>ğŸ¦¢ é»‘å¤©éµ</h4>
                        <p>é¦–æ—¥æš´è·Œ <strong>1000</strong> é»</p>
                    </div>
                </div>

                <!-- æƒ…å¢ƒçµæœè¡¨æ ¼ -->
                <div class="results-table-container" style="margin-top: 20px;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>å¤©æ•¸</th>
                                <th>æŒ‡æ•¸</th>
                                <th>ç´¯è¨ˆè®Šå‹•</th>
                                <th>ETF æç›Š</th>
                                <th class="col-a">ğŸ”´ ç­–ç•¥A</th>
                                <th class="col-b">ğŸ”µ ç­–ç•¥B</th>
                                <th class="col-c">ğŸŸ¢ ç­–ç•¥C</th>
                                <th class="col-a">ç¸½æç›ŠA</th>
                                <th class="col-b">ç¸½æç›ŠB</th>
                                <th class="col-c">ç¸½æç›ŠC</th>
                            </tr>
                        </thead>
                        <tbody id="scenario-result-body">
                            <tr>
                                <td colspan="10" style="text-align: center; color: var(--text-secondary);">
                                    ğŸ‘† é»æ“Šä¸Šæ–¹ä»»ä¸€æƒ…å¢ƒå¡ç‰‡å³å¯åŸ·è¡Œæ¨¡æ“¬</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="chart-container" id="scenario-chart-container" style="display: none;">
                    <h3>ğŸ“ˆ æƒ…å¢ƒæ¨¡æ“¬çµæœ</h3>
                    <canvas id="scenario-chart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="js/calculator.js?v=1.1.47"></script>
    <script>
        // ======== State ========
        const simState = {
            etfLots: 0, etfCost: 100, etfCurrentPrice: 100, tseIndex: 23000,
            strategies: { A: [], B: [], C: [] },
            realizedPnL: { A: 0, B: 0, C: 0 },
            dailyHistory: [],
            selectedScenario: null,
            batchChart: null,
            scenarioChart: null
        };

        // ======== Init ========
        document.addEventListener('DOMContentLoaded', () => {
            loadStateFromStorage();
            initTabs();
            initBatchMode();
            initScenarioMode();
            updatePositionInfo();
        });

        function loadStateFromStorage() {
            try {
                // ä½¿ç”¨èˆ‡ä¸»é é¢ç›¸åŒçš„ localStorage key: 'hedge_positions'
                const saved = localStorage.getItem('hedge_positions');
                if (saved) {
                    const data = JSON.parse(saved);
                    simState.etfLots = data.etfLots || 0;
                    simState.etfCost = data.etfCost || 100;
                    simState.etfCurrentPrice = data.etfCurrentPrice || 100;
                    simState.tseIndex = data.tseIndex || 23000;

                    // Load ALL 3 strategies
                    const ensureArray = d => !d ? [] : (Array.isArray(d) ? d : Object.values(d));

                    // ç­–ç•¥ A å­˜åœ¨ optionPositions
                    simState.strategies.A = ensureArray(data.optionPositions);

                    // ç­–ç•¥ B å­˜åœ¨ strategyB.positions
                    if (data.strategyB && data.strategyB.positions) {
                        simState.strategies.B = ensureArray(data.strategyB.positions);
                    }

                    // ç­–ç•¥ C å­˜åœ¨ strategyC.positions
                    if (data.strategyC && data.strategyC.positions) {
                        simState.strategies.C = ensureArray(data.strategyC.positions);
                    }

                    // Load realized PnL
                    if (data.realizedPnL) {
                        simState.realizedPnL.A = data.realizedPnL.A || 0;
                        simState.realizedPnL.B = data.realizedPnL.B || 0;
                        simState.realizedPnL.C = data.realizedPnL.C || 0;
                    }

                    console.log('âœ… æ¨¡æ“¬é è¼‰å…¥ç­–ç•¥:', {
                        A: simState.strategies.A.length,
                        B: simState.strategies.B.length,
                        C: simState.strategies.C.length
                    });
                }
                const dailyHistory = localStorage.getItem('simDailyHistory');
                if (dailyHistory) simState.dailyHistory = JSON.parse(dailyHistory);
            } catch (e) { console.error('Failed to load state:', e); }
        }

        function updatePositionInfo() {
            document.getElementById('info-etf-lots').textContent = simState.etfLots.toFixed(2);
            document.getElementById('info-current-index').textContent = simState.tseIndex.toLocaleString();
            document.getElementById('info-a-count').textContent = simState.strategies.A.length + ' å£';
            document.getElementById('info-b-count').textContent = simState.strategies.B.length + ' å£';
            document.getElementById('info-c-count').textContent = simState.strategies.C.length + ' å£';
            document.getElementById('info-a-realized').textContent = simState.realizedPnL.A.toLocaleString();
            document.getElementById('info-b-realized').textContent = simState.realizedPnL.B.toLocaleString();
            document.getElementById('info-c-realized').textContent = simState.realizedPnL.C.toLocaleString();
            document.getElementById('batch-start-index').value = simState.tseIndex;
        }

        // ======== Tabs ========
        function initTabs() {
            document.querySelectorAll('.sim-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.sim-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
                });
            });
        }

        // ======== PnL Calculation for a specific strategy ========
        function calculatePnLForStrategy(indexPrice, strategyKey) {
            const baseIndex = simState.tseIndex;
            const positions = simState.strategies[strategyKey] || [];
            const realized = simState.realizedPnL[strategyKey] || 0;

            // ETF PnL (shared across all strategies)
            let etfPnL = 0;
            if (simState.etfLots > 0 && baseIndex > 0) {
                const ratio = indexPrice / baseIndex;
                const newETFPrice = simState.etfCurrentPrice * Math.pow(ratio, 2);
                etfPnL = (newETFPrice - simState.etfCurrentPrice) * simState.etfLots * 1000;
            }

            // Option PnL
            let optPnL = 0;
            positions.forEach(pos => {
                if (pos.isClosed) return;
                const multiplier = (pos.product === 'å¾®å°' || pos.product === 'å¾®å°æœŸè²¨') ? 10 : 50;
                if (pos.type === 'Futures' || pos.product === 'å¾®å°æœŸè²¨') {
                    optPnL += (pos.direction === 'è³£å‡º' ? (pos.strike - indexPrice) : (indexPrice - pos.strike)) * pos.lots * 10;
                } else {
                    let intrinsic = pos.type === 'Call' ? Math.max(0, indexPrice - pos.strike) : Math.max(0, pos.strike - indexPrice);
                    optPnL += (pos.direction === 'è²·é€²' ? (intrinsic - pos.premium) : (pos.premium - intrinsic)) * pos.lots * multiplier;
                }
            });
            optPnL += realized;

            return { etfPnL: Math.round(etfPnL), optPnL: Math.round(optPnL), totalPnL: Math.round(etfPnL + optPnL) };
        }

        function calculateAllStrategies(indexPrice) {
            const a = calculatePnLForStrategy(indexPrice, 'A');
            const b = calculatePnLForStrategy(indexPrice, 'B');
            const c = calculatePnLForStrategy(indexPrice, 'C');
            return { etfPnL: a.etfPnL, A: a, B: b, C: c };
        }



        // ======== Batch Mode ========
        function initBatchMode() {
            document.getElementById('btn-run-batch').addEventListener('click', runBatch);

            // ç•¶æ³¢å‹•æ¨¡å¼æ”¹è®Šæ™‚ï¼Œæ§åˆ¶å„è¼¸å…¥æ¡†
            document.getElementById('batch-volatility-mode').addEventListener('change', function () {
                const mcRunsGroup = document.getElementById('mc-runs-group');
                const dailyChangeInput = document.getElementById('batch-daily-change');
                const dailyChangeLabel = document.getElementById('daily-change-label');
                const dailyChangeHint = document.getElementById('daily-change-hint');

                // è’™åœ°å¡ç¾…æ¨¡æ“¬æ¬¡æ•¸
                if (this.value === 'monte-carlo') {
                    mcRunsGroup.style.display = 'flex';
                } else {
                    mcRunsGroup.style.display = 'none';
                    document.getElementById('mc-stats').style.display = 'none';
                }

                // æ ¹æ“šæ¨¡å¼è¨­å®šæ¯æ—¥æ¼²è·Œè¼¸å…¥æ¡†ç‹€æ…‹å’Œèªªæ˜
                const modeSettings = {
                    'fixed': { enabled: true, label: 'æ¯æ—¥æ¼²è·Œ (é»)', hint: '' },
                    'random': { enabled: true, label: 'æ³¢å‹•ç¯„åœ (Â±é»)', hint: 'å¯¦éš›æ³¢å‹•åœ¨ Â±æ­¤å€¼ ä¹‹é–“' },
                    'random-large': { enabled: true, label: 'æ³¢å‹•ç¯„åœ (Â±é»)', hint: 'å¯¦éš›æ³¢å‹•åœ¨ Â±2å€æ­¤å€¼ ä¹‹é–“' },
                    'trend': { enabled: true, label: 'åŸºæº–æ¼²è·Œ (é»)', hint: 'æ¯å¤©å¢åŠ  10%' },
                    'trend-down': { enabled: true, label: 'åŸºæº–æ¼²è·Œ (é»)', hint: 'æ¯å¤©æ¸›å°‘ 10%' },
                    'v-shape': { enabled: true, label: 'æ¯æ—¥è®Šå‹• (é»)', hint: 'å…ˆè·Œå¾Œæ¼²' },
                    'inverse-v': { enabled: true, label: 'æ¯æ—¥è®Šå‹• (é»)', hint: 'å…ˆæ¼²å¾Œè·Œ' },
                    'sideways': { enabled: true, label: 'éœ‡ç›ªå¹…åº¦ (é»)', hint: 'åœ¨æ­¤ç¯„åœå…§ä¾†å›éœ‡ç›ª' },
                    'monte-carlo': { enabled: true, label: 'æ¯æ—¥æ¨™æº–å·® (é»)', hint: 'å¸¸æ…‹åˆ†å¸ƒçš„æ¨™æº–å·®' }
                };

                const setting = modeSettings[this.value] || modeSettings['fixed'];
                dailyChangeInput.disabled = !setting.enabled;
                dailyChangeInput.style.opacity = setting.enabled ? '1' : '0.5';
                dailyChangeLabel.textContent = setting.label;
                dailyChangeHint.textContent = setting.hint;
            });

            // å¤©æ•¸è¨­å®šæ–¹å¼åˆ‡æ›
            document.getElementById('batch-days-mode').addEventListener('change', function () {
                const daysGroup = document.getElementById('batch-days-group');
                const settlementGroup = document.getElementById('settlement-date-group');
                if (this.value === 'settlement') {
                    daysGroup.style.display = 'none';
                    settlementGroup.style.display = 'flex';
                    // é è¨­çµç®—æ—¥ç‚ºä¸‹ä¸€å€‹æ¯æœˆç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰
                    if (!document.getElementById('settlement-date').value) {
                        document.getElementById('settlement-date').value = getNextSettlementDate();
                    }
                    updateDaysRemaining();
                } else {
                    daysGroup.style.display = 'flex';
                    settlementGroup.style.display = 'none';
                }
            });

            // çµç®—æ—¥æ”¹è®Šæ™‚æ›´æ–°å‰©é¤˜å¤©æ•¸
            document.getElementById('settlement-date').addEventListener('change', updateDaysRemaining);
        }

        // è¨ˆç®—ä¸‹ä¸€å€‹çµç®—æ—¥ï¼ˆæ¯æœˆç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰ï¼‰
        function getNextSettlementDate() {
            const today = new Date();
            let year = today.getFullYear();
            let month = today.getMonth();

            // è¨ˆç®—é€™å€‹æœˆçš„ç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰
            let settlement = getThirdWednesday(year, month);

            // å¦‚æœå·²ç¶“éäº†é€™å€‹æœˆçš„çµç®—æ—¥ï¼Œå–ä¸‹å€‹æœˆ
            if (today > settlement) {
                month++;
                if (month > 11) { month = 0; year++; }
                settlement = getThirdWednesday(year, month);
            }

            return settlement.toISOString().split('T')[0];
        }

        function getThirdWednesday(year, month) {
            const firstDay = new Date(year, month, 1);
            const dayOfWeek = firstDay.getDay();
            // è¨ˆç®—ç¬¬ä¸€å€‹æ˜ŸæœŸä¸‰æ˜¯å¹¾è™Ÿ
            const firstWed = 1 + ((3 - dayOfWeek + 7) % 7);
            // ç¬¬ä¸‰å€‹æ˜ŸæœŸä¸‰ = ç¬¬ä¸€å€‹ + 14
            return new Date(year, month, firstWed + 14);
        }

        function updateDaysRemaining() {
            const settlementInput = document.getElementById('settlement-date');
            const daysRemainingEl = document.getElementById('days-remaining');
            if (settlementInput.value) {
                const settlement = new Date(settlementInput.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = settlement - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                daysRemainingEl.textContent = `è·çµç®—æ—¥: ${diffDays} å¤©`;
                // åŒæ­¥æ›´æ–° batch-days å€¼
                document.getElementById('batch-days').value = Math.max(1, diffDays);
            }
        }

        function runBatch() {
            // æ ¹æ“šæ¨¡å¼æ±ºå®šå¤©æ•¸
            const daysMode = document.getElementById('batch-days-mode').value;
            let days;
            if (daysMode === 'settlement') {
                const settlement = new Date(document.getElementById('settlement-date').value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                days = Math.ceil((settlement - today) / (1000 * 60 * 60 * 24));
                days = Math.max(1, days);
            } else {
                days = parseInt(document.getElementById('batch-days').value) || 10;
            }

            const startIndex = parseFloat(document.getElementById('batch-start-index').value) || simState.tseIndex;
            const dailyChange = parseFloat(document.getElementById('batch-daily-change').value) || 0;
            const mode = document.getElementById('batch-volatility-mode').value;
            const midPoint = Math.floor(days / 2);

            // è’™åœ°å¡ç¾…ç”¨çš„å¸¸æ…‹åˆ†å¸ƒéš¨æ©Ÿå‡½æ•¸ (Box-Muller)
            function gaussianRandom(mean = 0, stdev = 1) {
                const u = 1 - Math.random();
                const v = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                return z * stdev + mean;
            }

            // è¨ˆç®—å–®æ¬¡æ¨¡æ“¬çš„è®Šå‹•
            function getChange(mode, dayIndex, dailyChange) {
                switch (mode) {
                    case 'fixed': return dailyChange;
                    case 'random': return (Math.random() - 0.5) * 2 * Math.abs(dailyChange);
                    case 'random-large': return (Math.random() - 0.5) * 4 * Math.abs(dailyChange);
                    case 'trend': return dailyChange * (1 + dayIndex * 0.1);
                    case 'trend-down': return dailyChange * Math.max(0.1, 1 - dayIndex * 0.1);
                    case 'v-shape': return dayIndex < midPoint ? -Math.abs(dailyChange) : Math.abs(dailyChange) * 1.2;
                    case 'inverse-v': return dayIndex < midPoint ? Math.abs(dailyChange) : -Math.abs(dailyChange) * 1.2;
                    case 'sideways': return (Math.sin(dayIndex * 0.8) * 0.3 + (Math.random() - 0.5) * 0.2) * Math.abs(dailyChange);
                    case 'monte-carlo': return gaussianRandom(0, Math.abs(dailyChange));
                    default: return dailyChange;
                }
            }

            // ========== è’™åœ°å¡ç¾…å¤šæ¬¡æ¨¡æ“¬ ==========
            if (mode === 'monte-carlo') {
                const runs = parseInt(document.getElementById('mc-runs').value) || 100;
                const allResults = { A: [], B: [], C: [] };

                for (let run = 0; run < runs; run++) {
                    let currentIndex = startIndex;
                    for (let i = 0; i <= days; i++) {
                        currentIndex += getChange(mode, i, dailyChange);
                    }
                    // è¨ˆç®—æœ€çµ‚æ—¥çš„æç›Š
                    const finalPnl = calculateAllStrategies(currentIndex);
                    allResults.A.push(finalPnl.A.totalPnL);
                    allResults.B.push(finalPnl.B.totalPnL);
                    allResults.C.push(finalPnl.C.totalPnL);
                }

                // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
                const calcStats = (arr) => ({
                    avg: Math.round(arr.reduce((a, b) => a + b, 0) / arr.length),
                    winRate: Math.round((arr.filter(x => x >= 0).length / arr.length) * 100),
                    max: Math.max(...arr),
                    min: Math.min(...arr)
                });

                const statsA = calcStats(allResults.A);
                const statsB = calcStats(allResults.B);
                const statsC = calcStats(allResults.C);

                // é¡¯ç¤ºçµ±è¨ˆçµæœ
                document.getElementById('mc-stats').style.display = 'grid';
                document.getElementById('mc-total-runs').textContent = runs;
                document.getElementById('mc-avg-a').textContent = (statsA.avg >= 0 ? '+' : '') + statsA.avg.toLocaleString();
                document.getElementById('mc-avg-a').className = 'value ' + (statsA.avg >= 0 ? 'profit' : 'loss');
                document.getElementById('mc-avg-b').textContent = (statsB.avg >= 0 ? '+' : '') + statsB.avg.toLocaleString();
                document.getElementById('mc-avg-b').className = 'value ' + (statsB.avg >= 0 ? 'profit' : 'loss');
                document.getElementById('mc-avg-c').textContent = (statsC.avg >= 0 ? '+' : '') + statsC.avg.toLocaleString();
                document.getElementById('mc-avg-c').className = 'value ' + (statsC.avg >= 0 ? 'profit' : 'loss');
                document.getElementById('mc-winrate-a').textContent = statsA.winRate + '%';
                document.getElementById('mc-winrate-b').textContent = statsB.winRate + '%';
                document.getElementById('mc-winrate-c').textContent = statsC.winRate + '%';
                document.getElementById('mc-maxloss-a').textContent = statsA.min.toLocaleString();
                document.getElementById('mc-maxloss-b').textContent = statsB.min.toLocaleString();
                document.getElementById('mc-maxloss-c').textContent = statsC.min.toLocaleString();
                document.getElementById('mc-maxprofit-a').textContent = '+' + statsA.max.toLocaleString();
                document.getElementById('mc-maxprofit-b').textContent = '+' + statsB.max.toLocaleString();
                document.getElementById('mc-maxprofit-c').textContent = '+' + statsC.max.toLocaleString();

                // é¡¯ç¤ºä¸€å€‹ä»£è¡¨æ€§çš„å–®æ¬¡æ¨¡æ“¬çµæœ
            }

            // ========== ä¸€èˆ¬æ¨¡å¼ï¼ˆå–®æ¬¡æ¨¡æ“¬ï¼‰==========
            const results = [];
            let currentIndex = startIndex;

            for (let i = 0; i <= days; i++) {
                const pnl = calculateAllStrategies(currentIndex);
                results.push({ day: i, index: currentIndex, cumChange: currentIndex - startIndex, ...pnl });
                currentIndex += getChange(mode, i, dailyChange);
            }

            // Render table
            document.getElementById('batch-result-body').innerHTML = results.map(r => `
                <tr>
                    <td>ç¬¬ ${r.day} å¤©</td>
                    <td>${Math.round(r.index).toLocaleString()}</td>
                    <td class="${r.cumChange >= 0 ? 'profit' : 'loss'}">${r.cumChange >= 0 ? '+' : ''}${Math.round(r.cumChange)}</td>
                    <td class="${r.etfPnL >= 0 ? 'profit' : 'loss'}">${r.etfPnL >= 0 ? '+' : ''}${r.etfPnL.toLocaleString()}</td>
                    <td class="col-a ${r.A.optPnL >= 0 ? 'profit' : 'loss'}">${r.A.optPnL >= 0 ? '+' : ''}${r.A.optPnL.toLocaleString()}</td>
                    <td class="col-b ${r.B.optPnL >= 0 ? 'profit' : 'loss'}">${r.B.optPnL >= 0 ? '+' : ''}${r.B.optPnL.toLocaleString()}</td>
                    <td class="col-c ${r.C.optPnL >= 0 ? 'profit' : 'loss'}">${r.C.optPnL >= 0 ? '+' : ''}${r.C.optPnL.toLocaleString()}</td>
                    <td class="col-a ${r.A.totalPnL >= 0 ? 'profit' : 'loss'}" style="font-weight:700">${r.A.totalPnL >= 0 ? '+' : ''}${r.A.totalPnL.toLocaleString()}</td>
                    <td class="col-b ${r.B.totalPnL >= 0 ? 'profit' : 'loss'}" style="font-weight:700">${r.B.totalPnL >= 0 ? '+' : ''}${r.B.totalPnL.toLocaleString()}</td>
                    <td class="col-c ${r.C.totalPnL >= 0 ? 'profit' : 'loss'}" style="font-weight:700">${r.C.totalPnL >= 0 ? '+' : ''}${r.C.totalPnL.toLocaleString()}</td>
                </tr>
            `).join('');

            // Render chart
            renderBatchChart(results);
        }

        function renderBatchChart(results) {
            const ctx = document.getElementById('batch-chart').getContext('2d');
            if (simState.batchChart) simState.batchChart.destroy();
            simState.batchChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results.map(r => `D${r.day}`),
                    datasets: [
                        { label: 'ğŸ”´ ç­–ç•¥A ç¸½æç›Š', data: results.map(r => r.A.totalPnL), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: false, tension: 0.3 },
                        { label: 'ğŸ”µ ç­–ç•¥B ç¸½æç›Š', data: results.map(r => r.B.totalPnL), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: false, tension: 0.3 },
                        { label: 'ğŸŸ¢ ç­–ç•¥C ç¸½æç›Š', data: results.map(r => r.C.totalPnL), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: false, tension: 0.3 },
                        { label: 'ETF æç›Š', data: results.map(r => r.etfPnL), borderColor: '#f59e0b', borderDash: [5, 5], fill: false, tension: 0.3 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { ticks: { callback: v => v.toLocaleString() } } } }
            });
        }

        // ======== Scenario Mode ========
        function initScenarioMode() {
            // é»æ“Šå¡ç‰‡æ™‚é«˜äº®é¡¯ç¤º
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.addEventListener('click', function () {
                    document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // åˆå§‹åŒ–èµ·å§‹æŒ‡æ•¸
            document.getElementById('scenario-start-index').value = simState.tseIndex;
        }

        function runScenario(scenarioType) {
            const days = parseInt(document.getElementById('scenario-days').value) || 3;
            const startIndex = parseFloat(document.getElementById('scenario-start-index').value) || simState.tseIndex;

            // æ ¹æ“šæƒ…å¢ƒé¡å‹ç”¢ç”Ÿæ¯æ—¥è®Šå‹•
            const changes = generateScenarioChanges(scenarioType, days);
            const results = [];
            let currentIndex = startIndex;

            // ç¬¬ 0 å¤©
            const pnl0 = calculateAllStrategies(currentIndex);
            results.push({ day: 0, index: currentIndex, cumChange: 0, ...pnl0 });

            // å„å¤©è®Šå‹•
            changes.forEach((change, i) => {
                currentIndex += change;
                const pnl = calculateAllStrategies(currentIndex);
                results.push({ day: i + 1, index: currentIndex, cumChange: currentIndex - startIndex, ...pnl });
            });

            // é¡¯ç¤ºè¡¨æ ¼
            document.getElementById('scenario-result-body').innerHTML = results.map(r => `
                <tr>
                    <td>ç¬¬ ${r.day} å¤©</td>
                    <td>${Math.round(r.index).toLocaleString()}</td>
                    <td class="${r.cumChange >= 0 ? 'profit' : 'loss'}">${r.cumChange >= 0 ? '+' : ''}${Math.round(r.cumChange)}</td>
                    <td class="${r.etfPnL >= 0 ? 'profit' : 'loss'}">${r.etfPnL >= 0 ? '+' : ''}${r.etfPnL.toLocaleString()}</td>
                    <td class="col-a ${r.A.optPnL >= 0 ? 'profit' : 'loss'}">${r.A.optPnL >= 0 ? '+' : ''}${r.A.optPnL.toLocaleString()}</td>
                    <td class="col-b ${r.B.optPnL >= 0 ? 'profit' : 'loss'}">${r.B.optPnL >= 0 ? '+' : ''}${r.B.optPnL.toLocaleString()}</td>
                    <td class="col-c ${r.C.optPnL >= 0 ? 'profit' : 'loss'}">${r.C.optPnL >= 0 ? '+' : ''}${r.C.optPnL.toLocaleString()}</td>
                    <td class="col-a ${r.A.totalPnL >= 0 ? 'profit' : 'loss'}" style="font-weight:700">${r.A.totalPnL >= 0 ? '+' : ''}${r.A.totalPnL.toLocaleString()}</td>
                    <td class="col-b ${r.B.totalPnL >= 0 ? 'profit' : 'loss'}" style="font-weight:700">${r.B.totalPnL >= 0 ? '+' : ''}${r.B.totalPnL.toLocaleString()}</td>
                    <td class="col-c ${r.C.totalPnL >= 0 ? 'profit' : 'loss'}" style="font-weight:700">${r.C.totalPnL >= 0 ? '+' : ''}${r.C.totalPnL.toLocaleString()}</td>
                </tr>
            `).join('');

            // é¡¯ç¤ºåœ–è¡¨
            document.getElementById('scenario-chart-container').style.display = 'block';
            renderScenarioChart(results);
        }

        function generateScenarioChanges(type, days) {
            const midPoint = Math.floor(days / 2);
            switch (type) {
                case 'crash': return Array(days).fill(-300);
                case 'rally': return Array(days).fill(300);
                case 'moderate-drop': return Array(days).fill(-100);
                case 'moderate-rise': return Array(days).fill(100);
                case 'v-shape':
                    return Array(days).fill(0).map((_, i) => i < midPoint ? -200 : 250);
                case 'inverse-v':
                    return Array(days).fill(0).map((_, i) => i < midPoint ? 200 : -250);
                case 'sideways':
                    return Array(days).fill(0).map((_, i) => (Math.sin(i * 1.2) * 150));
                case 'black-swan':
                    return [-1000, ...Array(days - 1).fill(0).map((_, i) => 80 + i * 10)];
                default: return Array(days).fill(0);
            }
        }

        function renderScenarioChart(results) {
            const ctx = document.getElementById('scenario-chart').getContext('2d');
            if (simState.scenarioChart) simState.scenarioChart.destroy();
            simState.scenarioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results.map(r => `D${r.day}`),
                    datasets: [
                        { label: 'ğŸ”´ ç­–ç•¥A', data: results.map(r => r.A.totalPnL), borderColor: '#ef4444', fill: false, tension: 0.3 },
                        { label: 'ğŸ”µ ç­–ç•¥B', data: results.map(r => r.B.totalPnL), borderColor: '#3b82f6', fill: false, tension: 0.3 },
                        { label: 'ğŸŸ¢ ç­–ç•¥C', data: results.map(r => r.C.totalPnL), borderColor: '#22c55e', fill: false, tension: 0.3 },
                        { label: 'æŒ‡æ•¸', data: results.map(r => r.index), borderColor: '#f59e0b', yAxisID: 'y1', borderDash: [5, 5], fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { type: 'linear', position: 'left', ticks: { callback: v => v.toLocaleString() } },
                        y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
    </script>
</body>

</html>