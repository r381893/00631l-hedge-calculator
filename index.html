<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>00631L 避險計算器</title>
    <meta name="description" content="使用選擇權組合策略保護 00631L 持股的避險分析工具">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <link rel="stylesheet" href="css/style.css?v=1.1.45">
    <link rel="stylesheet" href="css/sensitivity.css?v=1.1.45">
    <link rel="stylesheet" href="css/simulation.css?v=1.1.45">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🛡️</span>
                <div class="logo-text">
                    <h1>00631L 避險計算器</h1>
                    <p>使用選擇權組合策略保護您的持股</p>
                </div>
            </div>
            <div class="market-info">
                <div class="market-item">
                    <span class="market-label">加權指數</span>
                    <span class="market-value" id="tse-index">--</span>
                </div>
                <div class="market-item">
                    <span class="market-label">00631L</span>
                    <span class="market-value" id="etf-price">--</span>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Mobile Sidebar Toggle Button (must be outside sidebar) -->
        <button class="sidebar-toggle" id="sidebar-toggle">
            <span>☰</span>
        </button>

        <!-- Sidebar Overlay (for closing on mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <!-- ETF Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">📊 00631L 庫存設定</h3>
                    <div class="form-group">
                        <label for="etf-lots">持有張數</label>
                        <input type="number" id="etf-lots" value="0" step="any" min="0">
                        <span class="form-hint">1張 = 1000股</span>
                    </div>
                    <div class="form-group">
                        <label for="etf-cost">平均成本 (元)</label>
                        <input type="number" id="etf-cost" value="100" step="any" min="0">
                    </div>
                    <div class="form-group">
                        <label for="etf-current">現價 (元)</label>
                        <input type="number" id="etf-current" value="100" step="any" min="0">
                    </div>
                </div>

                <!-- Hedge Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">🛡️ 避險設定</h3>
                    <div class="form-group">
                        <label for="hedge-ratio">每張 ETF 避險口數</label>
                        <input type="number" id="hedge-ratio" value="0.2" step="any" min="0" max="1">
                    </div>
                    <div class="suggested-hedge" id="hedge-suggestion">
                        <p class="suggested-label">📌 建議避險口數</p>
                        <p class="suggested-value" id="suggested-lots">0.0 口</p>
                        <p class="suggested-calc" id="suggested-calc"></p>
                    </div>
                </div>

                <!-- Account PnL -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">💵 選擇權帳戶</h3>
                    <div class="form-group">
                        <label for="account-cost">帳戶成本 (元)</label>
                        <input type="number" id="account-cost" value="0" step="any">
                        <span class="form-hint">初始投入金額</span>
                    </div>
                    <div class="form-group">
                        <label for="account-balance">目前餘額 (元)</label>
                        <input type="number" id="account-balance" value="0" step="any">
                        <span class="form-hint">帳戶現有金額</span>
                    </div>
                    <div class="account-pnl-display">
                        <span>帳戶損益:</span>
                        <span id="account-pnl-value">0 元</span>
                    </div>
                </div>

                <!-- Simulation Toggle -->
                <div class="sidebar-section">
                    <a href="simulation.html" class="btn btn-primary btn-full"
                        style="text-decoration: none; text-align: center;">🧪 開啟模擬分析中心</a>
                </div>

                <!-- Simulation Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">📈 模擬設定</h3>
                    <div class="form-group">
                        <label for="price-range">模擬範圍 (±點數)</label>
                        <input type="number" id="price-range" value="1500" step="100" min="100">
                    </div>
                    <div class="current-index">
                        <span>當前指數:</span>
                        <strong id="current-index-display">--</strong>
                    </div>
                    <!-- Reference Index for PnL Baseline -->
                    <div class="form-group mt-2">
                        <label for="reference-index">基準指數 (Reference Index)</label>
                        <input type="number" id="reference-index" step="1" title="用於計算 ETF 漲跌幅的基準點">
                        <span class="form-hint">設定建倉時的指數位置，用於比較 ETF 損益</span>
                    </div>
                </div>

                <!-- Firebase Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">🔥 Firebase</h3>

                    <!-- Status Only -->
                    <div class="firebase-status-row">
                        <span>連線狀態:</span>
                        <div class="status-indicator" id="firebase-status">
                            <span class="status-dot"></span>
                            <span class="status-text">未連線</span>
                        </div>
                    </div>

                    <!-- Sync Link -->
                    <button class="btn btn-sm btn-secondary btn-full mt-1" id="btn-copy-sync-link">📋 複製同步連結</button>
                    <p class="form-hint" style="font-size: 0.75rem; margin-top: 4px;">在其他裝置開啟此連結可同步資料</p>

                    <!-- Hidden Config (for advanced users, can be shown via dev tools) -->
                    <div style="display: none;">
                        <textarea id="firebase-config-input"></textarea>
                        <button id="btn-save-firebase-config"></button>
                        <button id="btn-reset-firebase"></button>
                        <button id="btn-test-firebase"></button>
                    </div>
                </div>
                <!-- AI Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">🤖 AI 設定</h3>
                    <div class="form-group">
                        <label for="ai-api-key">Google Gemini API Key</label>
                        <input type="password" id="ai-api-key" placeholder="貼上您的 API Key">
                    </div>
                    <!-- 
                    <div class="form-group">
                        <label for="ai-model">模型 (Model)</label>
                        <select id="ai-model">
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            <option value="gemini-pro">Gemini Pro</option>
                        </select>
                    </div>
                    -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Copy Strategy Card -->
            <section class="card" id="copy-strategy-card">
                <h2 class="section-title">📥 複製策略</h2>

                <div class="copy-flow-container">
                    <!-- Source -->
                    <div class="copy-step">
                        <label class="step-label">從哪裡複製 (Source)</label>
                        <select id="copy-source" class="form-select modern-select">
                            <option value="A">🔴 策略 A</option>
                            <option value="B">🔵 策略 B</option>
                            <option value="C">🟢 策略 C</option>
                        </select>
                    </div>

                    <!-- Arrow -->
                    <div class="flow-arrow">
                        ⬇️
                    </div>

                    <!-- Target -->
                    <div class="copy-step">
                        <label class="step-label">複製到哪裡 (Target)</label>
                        <select id="copy-target" class="form-select modern-select">
                            <option value="B" selected>🔵 策略 B</option>
                            <option value="A">🔴 策略 A</option>
                            <option value="C">🟢 策略 C</option>
                        </select>
                    </div>

                    <!-- Warning & Confirmation -->
                    <div class="safety-zone mt-4">
                        <div class="warning-box">
                            <i class="icon-warning">⚠️</i>
                            <span>注意：此操作將<strong>完全覆蓋</strong>目標策略的所有倉位資料。</span>
                        </div>

                        <div class="confirmation-checkbox">
                            <label>
                                <input type="checkbox" id="chk-confirm-copy">
                                <span>我已知悉風險，確認執行</span>
                            </label>
                        </div>

                        <button class="btn btn-primary btn-full mt-2" id="btn-confirm-copy" disabled>
                            確認複製
                        </button>
                    </div>
                </div>
            </section>

            <!-- AI Assistant Card -->
            <section class="card" id="ai-assistant-card">
                <h2 class="section-title">🤖 AI 策略助手</h2>
                <div class="ai-controls">
                    <button class="btn btn-ai-analysis btn-full" id="btn-ai-analysis">
                        🧠 執行 AI 策略診斷 (Gemini)
                    </button>
                    <div id="ai-loading" style="display: none; margin-top: 10px; text-align: center;">
                        <span class="loading-spinner"></span> 正在分析中...
                    </div>
                </div>

                <!-- AI Analysis Result -->
                <div id="ai-result-card" class="mt-3" style="display: none;">
                    <div class="result-header">
                        <h3>📊 診斷報告</h3>
                        <button class="btn-close-result" id="btn-close-ai">✕</button>
                    </div>
                    <div id="ai-result-content" class="markdown-content"></div>
                </div>
            </section>

            <!-- Add Position Section -->
            <section class="card" id="add-position-card">
                <h2 class="section-title">➕ 新增倉位</h2>

                <div class="tab-group">
                    <button class="tab active" data-product="Option">選擇權 (Option)</button>
                    <button class="tab" data-product="Futures">微台 (Futures)</button>
                </div>

                <!-- Option Form -->
                <div id="option-form" class="position-form">
                    <div class="compact-form-grid">
                        <!-- Row 1 Items -->
                        <div class="form-group">
                            <label>權利 (Type)</label>
                            <select id="opt-type">
                                <option value="Call">Call (買權)</option>
                                <option value="Put">Put (賣權)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>買賣方向</label>
                            <div class="radio-group">
                                <label class="radio-label buy-label">
                                    <input type="radio" name="opt-direction" value="買進" checked>
                                    <span>Buy</span>
                                </label>
                                <label class="radio-label sell-label">
                                    <input type="radio" name="opt-direction" value="賣出">
                                    <span>Sell</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>履約價 (Strike)</label>
                            <input type="number" id="opt-strike" step="100">
                        </div>

                        <div class="form-group">
                            <label>口數 (Lots)</label>
                            <input type="number" id="opt-lots" value="1" min="1">
                        </div>

                        <div class="form-group">
                            <label>成交價 (Premium)</label>
                            <div class="input-with-button">
                                <input type="number" id="opt-premium" step="any" min="0">
                                <button class="btn btn-sm btn-outline" id="btn-get-price" title="取得即時報價">
                                    🔍
                                </button>
                            </div>
                            <span id="price-loading" class="input-hint" style="display: none;">載入中...</span>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" id="btn-add-option">新增選擇權倉位</button>
                </div>

                <!-- Futures Form -->
                <div id="futures-form" class="position-form" style="display: none;">
                    <div class="alert-info mb-3">
                        💡 微台期貨固定為 <strong>做空 (Sell)</strong> 用於避險
                    </div>
                    <div class="compact-form-grid">
                        <div class="form-group">
                            <label>履約價 (Strike)</label>
                            <input type="number" id="futures-strike" step="100">
                        </div>
                        <div class="form-group">
                            <label>口數 (Lots)</label>
                            <input type="number" id="futures-lots" value="1" min="1">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" id="btn-add-futures">新增期貨倉位</button>
                </div>
            </section>

            <!-- Strategy Comparison -->
            <section class="card" id="positions-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">📋 策略比較</h2>
                    <div class="strategy-actions">
                        <button class="btn btn-sm btn-secondary" id="btn-group-positions" title="建立複試單群組" disabled>
                            🔗 建立群組
                        </button>
                        <button class="btn btn-sm btn-danger" id="btn-clear-strategy" title="清空當前策略">
                            🧹 清空
                        </button>
                    </div>
                </div>

                <!-- Dual Column Positions -->
                <div class="comparison-grid">
                    <!-- Strategy A -->
                    <div class="strategy-column" id="strategy-col-a">
                        <div class="strategy-header strategy-a">
                            <span class="strategy-label">🔴 策略 A</span>
                            <span class="strategy-count" id="count-a">0 筆</span>
                        </div>
                        <div class="positions-list" id="positions-list-a"></div>
                        <div class="premium-summary">
                            <div class="premium-row">
                                <span>收入:</span>
                                <span class="profit" id="premium-in-a">+0</span>
                            </div>
                            <div class="premium-row">
                                <span>支出:</span>
                                <span class="loss" id="premium-out-a">-0</span>
                            </div>
                            <div class="premium-row premium-net">
                                <span>淨額:</span>
                                <span id="premium-net-a">0 元</span>
                            </div>
                            <div class="premium-row realized-pnl-row">
                                <label for="realized-pnl-a">已實現:</label>
                                <input type="number" id="realized-pnl-a" class="realized-pnl-input" value="0"
                                    step="any">
                            </div>
                        </div>
                    </div>

                    <!-- Strategy B -->
                    <div class="strategy-column" id="strategy-col-b">
                        <div class="strategy-header strategy-b">
                            <span class="strategy-label">🔵 策略 B</span>
                            <span class="strategy-count" id="count-b">0 筆</span>
                        </div>
                        <div class="positions-list" id="positions-list-b"></div>
                        <div class="premium-summary">
                            <div class="premium-row">
                                <span>收入:</span>
                                <span class="profit" id="premium-in-b">+0</span>
                            </div>
                            <div class="premium-row">
                                <span>支出:</span>
                                <span class="loss" id="premium-out-b">-0</span>
                            </div>
                            <div class="premium-row premium-net">
                                <span>淨額:</span>
                                <span id="premium-net-b">0 元</span>
                            </div>
                            <div class="premium-row realized-pnl-row">
                                <label for="realized-pnl-b">已實現:</label>
                                <input type="number" id="realized-pnl-b" class="realized-pnl-input" value="0"
                                    step="any">
                            </div>
                        </div>
                    </div>

                    <!-- Strategy C -->
                    <div class="strategy-column" id="strategy-col-c">
                        <div class="strategy-header strategy-c">
                            <span class="strategy-label">🟢 策略 C</span>
                            <span class="strategy-count" id="count-c">0 筆</span>
                        </div>
                        <div class="positions-list" id="positions-list-c"></div>
                        <div class="premium-summary">
                            <div class="premium-row">
                                <span>收入:</span>
                                <span class="profit" id="premium-in-c">+0</span>
                            </div>
                            <div class="premium-row">
                                <span>支出:</span>
                                <span class="loss" id="premium-out-c">-0</span>
                            </div>
                            <div class="premium-row premium-net">
                                <span>淨額:</span>
                                <span id="premium-net-c">0 元</span>
                            </div>
                            <div class="premium-row realized-pnl-row">
                                <label for="realized-pnl-c">已實現:</label>
                                <input type="number" id="realized-pnl-c" class="realized-pnl-input" value="0"
                                    step="any">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add to Strategy -->
                <div class="add-to-strategy">
                    <span>新增倉位到:</span>
                    <button class="btn btn-sm strategy-add-btn active" id="btn-add-to-a" data-strategy="A">🔴 A</button>
                    <button class="btn btn-sm strategy-add-btn" id="btn-add-to-b" data-strategy="B">🔵 B</button>
                    <button class="btn btn-sm strategy-add-btn" id="btn-add-to-c" data-strategy="C">🟢 C</button>
                </div>
            </section>



            <!-- AI Inventory Parser Removed -->

            <!-- Simulation Section -->
            <section class="card" id="simulation-card" style="display: none;">
                <h2 class="section-title">🧪 模擬實驗室 (Simulation)</h2>

                <div class="simulation-controls">
                    <!-- Control Grid -->
                    <div class="sim-control-grid">
                        <!-- Index Change -->
                        <div class="sim-control-item">
                            <label>指數變動 (Points)</label>
                            <div class="range-with-input">
                                <input type="range" id="sim-index-change-slider" min="-2000" max="2000" step="10"
                                    value="0">
                                <input type="number" id="sim-index-change-input" value="0" step="10">
                            </div>
                            <div class="sim-value-display">
                                模擬指數: <span id="sim-projected-index">--</span>
                            </div>
                        </div>

                        <!-- Days Passing -->
                        <div class="sim-control-item">
                            <label>經過天數 (Days)</label>
                            <div class="range-with-input">
                                <input type="range" id="sim-days-slider" min="0" max="30" step="1" value="1">
                                <input type="number" id="sim-days-input" value="1" min="0" max="180">
                            </div>
                            <div class="sim-value-display">
                                剩餘天數推估: <span id="sim-remaining-days">--</span> (假設剩餘 <input type="number"
                                    id="sim-initial-days" value="15" style="width: 50px; padding: 2px;"> 天)
                            </div>
                        </div>

                        <!-- Volatility Change -->
                        <div class="sim-control-item">
                            <label>波動率變動 (Vol %)</label>
                            <div class="range-with-input">
                                <input type="range" id="sim-vol-change-slider" min="-10" max="10" step="1" value="0">
                                <input type="number" id="sim-vol-change-input" value="0" step="1">
                            </div>
                            <div class="sim-value-display">
                                假設 IV: <span id="sim-projected-vol">20%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="sim-actions mt-3">
                        <button class="btn btn-secondary btn-sm" id="btn-reset-sim">↺ 重置參數</button>
                    </div>
                </div>

                <!-- Results Display -->
                <div class="sim-results mt-4">
                    <div class="sim-result-grid">
                        <!-- Total PnL -->
                        <div class="sim-result-card total">
                            <div class="label">預估總損益</div>
                            <div class="value" id="sim-total-pnl">--</div>
                            <div class="sub-value" id="sim-total-pnl-change">--</div>
                        </div>

                        <!-- ETF PnL -->
                        <div class="sim-result-card">
                            <div class="label">ETF 損益</div>
                            <div class="value" id="sim-etf-pnl">--</div>
                            <div class="diff" id="sim-etf-diff">--</div>
                        </div>

                        <!-- Option PnL -->
                        <div class="sim-result-card">
                            <div class="label">期權損益</div>
                            <div class="value" id="sim-opt-pnl">--</div>
                            <div class="diff" id="sim-opt-diff">--</div>
                        </div>
                    </div>

                    <!-- Detailed Greeks (Optional, maybe later) -->
                    <div class="sim-details mt-3" style="font-size: 0.9em; color: var(--text-secondary);">
                        * 模擬採用 Black-Scholes 模型估算，僅供參考。<br>
                        * 微台期貨以 Delta=1 計算，不計時間價值。
                    </div>
                </div>
            </section>

            <!-- Sensitivity Analysis Card -->
            <section class="card" id="sensitivity-card">
                <h2 class="section-title">📊 損益敏感度分析 (±100點)</h2>
                <div class="sensitivity-grid">
                    <!-- Down 100 -->
                    <div class="sensitivity-item down">
                        <div class="sen-header">
                            <span class="sen-label">📉 下跌 100 點</span>
                            <span class="sen-index" id="sen-index-down">--</span>
                        </div>
                        <div class="sen-body">
                            <div class="sen-row">
                                <span>ETF 損益變化</span>
                                <span class="sen-value" id="sen-etf-down">--</span>
                            </div>
                            <div class="sen-row strategy-row">
                                <span>策略損益變化</span>
                                <span class="sen-value" id="sen-strategy-down">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Current -->
                    <div class="sensitivity-item current">
                        <div class="sen-header">
                            <span class="sen-label">🎯 當前指數</span>
                            <span class="sen-index" id="sen-index-current">--</span>
                        </div>
                        <div class="sen-body">
                            <div class="sen-row">
                                <span>ETF 當前損益</span>
                                <span class="sen-value" id="sen-etf-current">--</span>
                            </div>
                            <div class="sen-row strategy-row">
                                <span>策略當前損益</span>
                                <span class="sen-value" id="sen-strategy-current">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Up 100 -->
                    <div class="sensitivity-item up">
                        <div class="sen-header">
                            <span class="sen-label">📈 上漲 100 點</span>
                            <span class="sen-index" id="sen-index-up">--</span>
                        </div>
                        <div class="sen-body">
                            <div class="sen-row">
                                <span>ETF 損益變化</span>
                                <span class="sen-value" id="sen-etf-up">--</span>
                            </div>
                            <div class="sen-row strategy-row">
                                <span>策略損益變化</span>
                                <span class="sen-value" id="sen-strategy-up">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PnL Chart -->
            <section class="card" id="pnl-chart-section">
                <h2 class="section-title">📈 損益曲線</h2>
                <div class="chart-container">
                    <canvas id="pnl-chart"></canvas>
                    <div class="chart-empty-state" id="chart-empty-state">
                        <div class="empty-icon">📊</div>
                        <p class="empty-title">尚未新增倉位</p>
                        <p class="empty-hint">請從上方「新增倉位」區塊加入選擇權或微台期貨，即可查看損益曲線。</p>
                    </div>
                </div>
                <div class="chart-legend">
                    📊 <b>圖例說明：</b>
                    <span class="legend-item legend-etf">00631L</span> = ETF損益 |
                    <span class="legend-item legend-option">Options</span> = 選擇權組合 |
                    <span class="legend-item legend-total">Total P/L</span> = 組合總損益 |
                    <span class="legend-item legend-current">Current</span> = 現價
                </div>
            </section>

            <!-- PnL Table -->
            <section class="card" id="pnl-table-section">
                <h2 class="section-title">📊 損益試算表</h2>
                <div class="table-container">
                    <table class="pnl-table" id="pnl-table">
                        <thead>
                            <tr>
                                <th>變動</th>
                                <th>指數</th>
                                <th class="col-strategy-a">🔴 策略 A</th>
                                <th class="col-strategy-b">🔵 策略 B</th>
                                <th class="col-strategy-c">🟢 策略 C</th>
                                <th>00631L</th>
                                <th>ETF損益變化</th>
                                <th>帳戶</th>
                                <th class="col-total-a">總損益 (A)</th>
                                <th class="col-total-b">總損益 (B)</th>
                                <th class="col-total-c">總損益 (C)</th>
                            </tr>
                        </thead>
                        <tbody id="pnl-table-body">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>💡 選擇權乘數: 50 元/點 | 00631L 槓桿: 2x | <span id="app-version">v1.2.0</span></p>
        <p><span id="save-status">--</span></p>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon"></span>
        <span class="toast-message"></span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Custom JS -->
    <script src="js/calculator.js?v=1.1.45"></script>
    <script src="js/chart.js?v=1.1.45"></script>
    <script src="js/firebase.js?v=1.1.45"></script>
    <script src="js/simulation.js?v=1.1.45"></script>
    <script src="js/app.js?v=1.1.45"></script>
</body>

</html>