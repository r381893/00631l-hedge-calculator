<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>00631L 避險計算器</title>
    <meta name="description" content="使用選擇權組合策略保護 00631L 持股的避險分析工具">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🛡️</span>
                <div class="logo-text">
                    <h1>00631L 避險計算器</h1>
                    <p>使用選擇權組合策略保護您的持股</p>
                </div>
            </div>
            <div class="market-info">
                <div class="market-item">
                    <span class="market-label">加權指數</span>
                    <span class="market-value" id="tse-index">--</span>
                </div>
                <div class="market-item">
                    <span class="market-label">00631L</span>
                    <span class="market-value" id="etf-price">--</span>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebar-toggle">
                <span>☰</span>
            </button>

            <div class="sidebar-content">
                <!-- ETF Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">📊 00631L 庫存設定</h3>
                    <div class="form-group">
                        <label for="etf-lots">持有張數</label>
                        <input type="number" id="etf-lots" value="0" step="any" min="0">
                        <span class="form-hint">1張 = 1000股</span>
                    </div>
                    <div class="form-group">
                        <label for="etf-cost">平均成本 (元)</label>
                        <input type="number" id="etf-cost" value="100" step="any" min="0">
                    </div>
                    <div class="form-group">
                        <label for="etf-current">現價 (元)</label>
                        <input type="number" id="etf-current" value="100" step="any" min="0">
                    </div>
                </div>

                <!-- Hedge Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">🛡️ 避險設定</h3>
                    <div class="form-group">
                        <label for="hedge-ratio">每張 ETF 避險口數</label>
                        <input type="number" id="hedge-ratio" value="0.2" step="any" min="0" max="1">
                    </div>
                    <div class="suggested-hedge" id="hedge-suggestion">
                        <p class="suggested-label">📌 建議避險口數</p>
                        <p class="suggested-value" id="suggested-lots">0.0 口</p>
                        <p class="suggested-calc" id="suggested-calc"></p>
                    </div>
                </div>

                <!-- Account PnL -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">💵 選擇權帳戶</h3>
                    <div class="form-group">
                        <label for="account-cost">帳戶成本 (元)</label>
                        <input type="number" id="account-cost" value="0" step="any">
                        <span class="form-hint">初始投入金額</span>
                    </div>
                    <div class="form-group">
                        <label for="account-balance">目前餘額 (元)</label>
                        <input type="number" id="account-balance" value="0" step="any">
                        <span class="form-hint">帳戶現有金額</span>
                    </div>
                    <div class="account-pnl-display">
                        <span>帳戶損益:</span>
                        <span id="account-pnl-value">0 元</span>
                    </div>
                </div>

                <!-- Simulation Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">📈 模擬設定</h3>
                    <div class="form-group">
                        <label for="price-range">模擬範圍 (±點數)</label>
                        <input type="number" id="price-range" value="1500" step="100" min="100">
                    </div>
                    <div class="current-index">
                        <span>當前指數:</span>
                        <strong id="current-index-display">--</strong>
                    </div>
                </div>

                <!-- Firebase Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">🔥 Firebase 設定</h3>

                    <!-- Status -->
                    <div class="firebase-status-row">
                        <span>連線狀態:</span>
                        <div class="status-indicator" id="firebase-status">
                            <span class="status-dot"></span>
                            <span class="status-text">未連線</span>
                        </div>
                    </div>

                    <!-- Config Input -->
                    <div class="form-group mt-2">
                        <label for="firebase-config-input">Firebase Config (JSON)</label>
                        <textarea id="firebase-config-input" class="code-font" rows="5" placeholder='請貼上 Firebase Config JSON:
{
  "apiKey": "...",
  "authDomain": "...",
  "databaseURL": "..."
}'></textarea>
                    </div>
                    <button class="btn btn-sm btn-primary btn-full" id="btn-save-firebase-config">💾 儲存並連線</button>
                    <button class="btn btn-sm btn-secondary btn-full mt-1" id="btn-reset-firebase">🔄 重置預設值</button>
                </div>
                <!-- AI Settings -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">🤖 AI 設定</h3>
                    <div class="form-group">
                        <label for="ai-api-key">Google Gemini API Key</label>
                        <input type="password" id="ai-api-key" placeholder="貼上您的 API Key">
                    </div>
                    <!-- 
                    <div class="form-group">
                        <label for="ai-model">模型 (Model)</label>
                        <select id="ai-model">
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            <option value="gemini-pro">Gemini Pro</option>
                        </select>
                    </div>
                    -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Copy Strategy Card -->
            <section class="card" id="copy-strategy-card">
                <h2 class="section-title">📥 複製策略</h2>
                <div class="copy-controls">
                    <div class="copy-group">
                        <select id="copy-source" class="form-select">
                            <option value="A">🔴 策略 A</option>
                            <option value="B">🔵 策略 B</option>
                            <option value="C">🟢 策略 C</option>
                        </select>
                    </div>
                </div>

                <!-- AI Strategy Analysis Button -->
                <div class="ai-analysis-trigger mt-3">
                    <button class="btn btn-ai-analysis btn-full" id="btn-ai-analysis">
                        🤖 AI 策略診斷 (Gemini)
                    </button>
                    <div id="ai-loading" style="display: none; margin-top: 10px; text-align: center;">
                        <span class="loading-spinner"></span> 正在分析中...
                    </div>
                </div>



                <!-- AI Analysis Result -->
                <div id="ai-result-card" class="card mt-3" style="display: none;">
                    <div class="result-header">
                        <h3>🤖 診斷報告</h3>
                        <button class="btn-close-result" id="btn-close-ai">✕</button>
                    </div>
                    <div id="ai-result-content" class="markdown-content"></div>
                </div>
                <!-- Removed stray /section here to keep Copy Controls inside -->
                <div class="copy-arrow">➔</div>
                <div class="copy-group">
                    <label for="copy-target">複製到 (目標):</label>
                    <select id="copy-target" class="form-select">
                        <option value="B" selected>🔵 策略 B</option>
                        <option value="A">🔴 策略 A</option>
                        <option value="C">🟢 策略 C</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="btn-confirm-copy">確認複製</button>
                <span class="copy-hint" id="copy-hint">⚠️ 將覆蓋目標策略</span>

            </section>

            <!-- Add Position Section -->
            <section class="card" id="add-position-card">
                <h2 class="section-title">➕ 新增倉位</h2>

                <div class="tab-group">
                    <button class="tab active" data-product="Option">選擇權 (Option)</button>
                    <button class="tab" data-product="Futures">微台 (Futures)</button>
                </div>

                <!-- Option Form -->
                <div id="option-form" class="position-form">
                    <div class="compact-form-grid">
                        <!-- Row 1 Items -->
                        <div class="form-group">
                            <label>權利 (Type)</label>
                            <select id="opt-type">
                                <option value="Call">Call (買權)</option>
                                <option value="Put">Put (賣權)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>買賣方向</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="opt-direction" value="買進" checked>
                                    <span>Buy</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="opt-direction" value="賣出">
                                    <span>Sell</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>履約價 (Strike)</label>
                            <input type="number" id="opt-strike" step="100">
                        </div>

                        <div class="form-group">
                            <label>口數 (Lots)</label>
                            <input type="number" id="opt-lots" value="1" min="1">
                        </div>

                        <div class="form-group">
                            <label>成交價 (Premium)</label>
                            <input type="number" id="opt-premium" step="any" min="0">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" id="btn-add-option">新增選擇權倉位</button>

                    <!-- Strike Picker -->
                    <div id="strike-picker-grid" class="mt-4"></div>
                </div>

                <!-- Futures Form -->
                <div id="futures-form" class="position-form" style="display: none;">
                    <div class="alert-info mb-3">
                        💡 微台期貨固定為 <strong>做空 (Sell)</strong> 用於避險
                    </div>
                    <div class="compact-form-grid">
                        <div class="form-group">
                            <label>履約價 (Strike)</label>
                            <input type="number" id="futures-strike" step="100">
                        </div>
                        <div class="form-group">
                            <label>口數 (Lots)</label>
                            <input type="number" id="futures-lots" value="1" min="1">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" id="btn-add-futures">新增期貨倉位</button>
                </div>
            </section>

            <!-- Strategy Comparison -->
            <section class="card" id="positions-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">📋 策略比較</h2>
                    <div class="strategy-actions">
                        <button class="btn btn-sm btn-secondary" id="btn-group-positions" title="建立複試單群組" disabled>
                            🔗 建立群組
                        </button>
                        <button class="btn btn-sm btn-danger" id="btn-clear-strategy" title="清空當前策略">
                            🧹 清空
                        </button>
                    </div>
                </div>

                <!-- Dual Column Positions -->
                <div class="comparison-grid">
                    <!-- Strategy A -->
                    <div class="strategy-column" id="strategy-col-a">
                        <div class="strategy-header strategy-a">
                            <span class="strategy-label">🔴 策略 A</span>
                            <span class="strategy-count" id="count-a">0 筆</span>
                        </div>
                        <div class="positions-list" id="positions-list-a"></div>
                        <div class="premium-summary">
                            <div class="premium-row">
                                <span>收入:</span>
                                <span class="profit" id="premium-in-a">+0</span>
                            </div>
                            <div class="premium-row">
                                <span>支出:</span>
                                <span class="loss" id="premium-out-a">-0</span>
                            </div>
                            <div class="premium-row premium-net">
                                <span>淨額:</span>
                                <span id="premium-net-a">0 元</span>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy B -->
                    <div class="strategy-column" id="strategy-col-b">
                        <div class="strategy-header strategy-b">
                            <span class="strategy-label">🔵 策略 B</span>
                            <span class="strategy-count" id="count-b">0 筆</span>
                        </div>
                        <div class="positions-list" id="positions-list-b"></div>
                        <div class="premium-summary">
                            <div class="premium-row">
                                <span>收入:</span>
                                <span class="profit" id="premium-in-b">+0</span>
                            </div>
                            <div class="premium-row">
                                <span>支出:</span>
                                <span class="loss" id="premium-out-b">-0</span>
                            </div>
                            <div class="premium-row premium-net">
                                <span>淨額:</span>
                                <span id="premium-net-b">0 元</span>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy C -->
                    <div class="strategy-column" id="strategy-col-c">
                        <div class="strategy-header strategy-c">
                            <span class="strategy-label">🟢 策略 C</span>
                            <span class="strategy-count" id="count-c">0 筆</span>
                        </div>
                        <div class="positions-list" id="positions-list-c"></div>
                        <div class="premium-summary">
                            <div class="premium-row">
                                <span>收入:</span>
                                <span class="profit" id="premium-in-c">+0</span>
                            </div>
                            <div class="premium-row">
                                <span>支出:</span>
                                <span class="loss" id="premium-out-c">-0</span>
                            </div>
                            <div class="premium-row premium-net">
                                <span>淨額:</span>
                                <span id="premium-net-c">0 元</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add to Strategy -->
                <div class="add-to-strategy">
                    <span>新增倉位到:</span>
                    <button class="btn btn-sm strategy-add-btn active" id="btn-add-to-a" data-strategy="A">🔴 A</button>
                    <button class="btn btn-sm strategy-add-btn" id="btn-add-to-b" data-strategy="B">🔵 B</button>
                    <button class="btn btn-sm strategy-add-btn" id="btn-add-to-c" data-strategy="C">🟢 C</button>
                </div>
            </section>



            <!-- AI Inventory Parser -->
            <section class="card" id="ai-inventory">
                <details>
                    <summary class="section-title-summary">
                        <h2 class="section-title inline-title">🤖 AI 庫存判讀 (點擊展開)</h2>
                    </summary>

                    <!-- 圖片上傳 -->
                    <div class="ocr-section">
                        <p class="upload-hint">📸 上傳券商庫存截圖，AI 自動辨識選擇權倉位</p>
                        <div class="image-upload-area" id="image-upload-area">
                            <input type="file" id="image-upload" accept="image/*" hidden>
                            <div class="upload-content">
                                <span class="upload-icon">📷</span>
                                <p>拖曳圖片到這裡，或<button class="btn-link" id="btn-browse-image">點擊上傳</button></p>
                            </div>
                        </div>
                        <div class="image-preview" id="image-preview" style="display: none;">
                            <img id="preview-img" src="" alt="預覽">
                            <button class="btn btn-primary" id="btn-ocr-recognize">🔍 AI 辨識圖片</button>
                            <button class="btn btn-secondary" id="btn-clear-image">🧹 清除</button>
                        </div>
                    </div>

                    <div class="divider-or"><span>或</span></div>

                    <!-- 文字貼上 -->
                    <p class="upload-hint">📝 貼上券商庫存資料（支援富邦、永豐、元大等格式）</p>
                    <div class="form-group">
                        <textarea id="inventory-text" rows="4" placeholder="請貼上您的庫存資料..."></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="btn-parse-inventory">🔍 解析文字</button>
                        <button class="btn btn-secondary" id="btn-clear-inventory">🧹 清空</button>
                    </div>

                    <div class="parse-results" id="parse-results" style="display: none;">
                        <h4>📊 解析結果</h4>
                        <div class="parsed-etf" id="parsed-etf"></div>
                        <div class="parsed-options" id="parsed-options"></div>
                        <button class="btn btn-success btn-full" id="btn-apply-parsed">✅ 套用到計算器</button>
                    </div>
                </details>
            </section>

            <!-- PnL Chart -->
            <section class="card" id="pnl-chart-section">
                <h2 class="section-title">📈 損益曲線</h2>
                <div class="chart-container">
                    <canvas id="pnl-chart"></canvas>
                </div>
                <div class="chart-legend">
                    📊 <b>圖例說明：</b>
                    <span class="legend-item legend-etf">00631L</span> = ETF損益 |
                    <span class="legend-item legend-option">Options</span> = 選擇權組合 |
                    <span class="legend-item legend-total">Total P/L</span> = 組合總損益 |
                    <span class="legend-item legend-current">Current</span> = 現價
                </div>
            </section>

            <!-- PnL Table -->
            <section class="card" id="pnl-table-section">
                <h2 class="section-title">📊 損益試算表</h2>
                <div class="table-container">
                    <table class="pnl-table" id="pnl-table">
                        <thead>
                            <tr>
                                <th>變動</th>
                                <th class="col-strategy-a">🔴 策略 A</th>
                                <th class="col-strategy-b">🔵 策略 B</th>
                                <th class="col-strategy-c">🟢 策略 C</th>
                                <th>00631L</th>
                                <th>ETF損益變化</th>
                                <th>帳戶</th>
                                <th class="col-total-a">總損益 (A)</th>
                                <th class="col-total-b">總損益 (B)</th>
                                <th class="col-total-c">總損益 (C)</th>
                            </tr>
                        </thead>
                        <tbody id="pnl-table-body">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>💡 選擇權乘數: 50 元/點 | 00631L 槓桿: 2x</p>
        <p>Version: <span id="app-version">V1.1.1</span> | 資料更新時間: <span id="update-time">--</span> | <span
                id="save-status">--</span></p>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon"></span>
        <span class="toast-message"></span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Custom JS -->
    <script src="js/calculator.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/firebase.js"></script>
    <script src="js/app.js?v=1.1.1"></script>
</body>

</html>